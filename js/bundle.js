(()=>{"use strict";(()=>{const e=document.querySelector(".map .map__pin--main"),t={width:e.offsetWidth,height:e.offsetHeight},n={X:e.style.left,Y:e.style.top},o={x:e.offsetLeft,y:e.offsetTop};window.constants={LEFT_MOUSE_BUTTON:[0,4],ENTER_KEY:"Enter",ESC_KEY:"Escape",PIN_POINTER_HEIGHT:18,MAX_PIN_ON_MAP:5,DEBOUNCE_INTERVAL:1500,FILE_TYPES:["gif","jpg","jpeg","png"],AVATAR_SRC:"img/muffin-grey.svg",url:{POST:"https://21.javascript.pages.academy/keksobooking",GET:"https://21.javascript.pages.academy/keksobooking/data"},mapDragArea:{Y:{TOP:130,BOTTOM:630},X:{LEFT:0,RIGHT:1200}},minPrice:{bungalow:0,flat:1e3,house:5e3,palace:1e4},priceLimits:{LOW:1e4,HIGH:5e4},featuresClasses:{wifi:"popup__feature--wifi",dishwasher:"popup__feature--dishwasher",parking:"popup__feature--parking",washer:"popup__feature--washer",elevator:"popup__feature--elevator",conditioner:"popup__feature--conditioner"},mainPinSize:t,mainPinLocation:o,typesOfAccommodation:{palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},initialMainPinLocation:n,pinsData:[]}})(),(()=>{let e;window.util={getRandomFromNumbers:(e,t)=>Math.floor(Math.random()*(t-e))+e,getRandomFromArray:(e,t)=>e.sort((()=>Math.random()-Math.random())).slice(0,t),declension:(e,t)=>e[t%100>4&&t%100<20?2:[2,0,1,1,1,2][t%10<5?t%10:5]],setInputValue:(e,t)=>{e.value=t},checkFormValidation:e=>{Array.from(e.elements).forEach((e=>{(e=>{let t="";(e.minLength||e.maxLength)&&(t=window.util.declension(["символ","символа","символов"],e.value.length)),e.required&&e.validity.valueMissing?e.setCustomValidity("Пожалуйста, заполните это поле."):e.minLength&&e.validity.tooShort?e.setCustomValidity(`Пожалуйста введите минимум ${e.minLength} ${t} (введено ${e.value.length} ${t})`):e.maxLength&&e.validity.tooShort?e.setCustomValidity(`Пожалуйста введите максимум ${e.maxLength} ${t} (введено ${e.value.length} ${t})`):e.min&&e.validity.rangeUnderflow?e.setCustomValidity("Минимальное значение "+e.min):e.max&&e.validity.rangeOverflow?e.setCustomValidity("Максимальное значение "+e.max):e.setCustomValidity("")})(e)}))},debounce:t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,window.constants.DEBOUNCE_INTERVAL)}}})(),(()=>{const e=document.querySelector("#error").content.querySelector(".error"),t=e=>{e.preventDefault(),e.code===window.constants.ESC_KEY&&document.contains(document.querySelector(".error"))&&(document.querySelector(".error").remove(),document.removeEventListener("keydown",t))},n=e=>{e.preventDefault(),document.contains(document.querySelector(".error"))&&(document.querySelector(".error").removeEventListener("click",n),document.querySelector(".error").remove())};window.errors={renderPostPopupMessage:()=>{const o=e.cloneNode(!0);document.body.appendChild(o),document.addEventListener("keydown",t),o.addEventListener("click",n)},renderErrorNode:e=>{const o=document.createElement("div");o.classList.add("error","error-message"),o.textContent=(e=>{const t="Пожалуйста, перегрузите страницу";let n;switch(e){case 400:n="Неверный запрос. "+t;break;case 401:n="Пользователь не авторизован.";break;case 403:n="Доступ запрещен.";break;case 404:n="Ничего не найдено.";break;default:n=`${e}. ${t}`}return n})(e),document.body.insertAdjacentElement("afterbegin",o),document.addEventListener("keydown",t),o.addEventListener("click",n)}}})(),(()=>{const e=(e,t,n,o=null)=>{const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{200===r.status?"GET"===e?t(r.response):t():n(r.status)})),r.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${r.timeout} мс`)})),r.timeout=1e4,"GET"===e?r.open(e,window.constants.url.GET):"POST"===e&&r.open(e,window.constants.url.POST),r.send(o)};window.backend={load:(t,n)=>{e("GET",t,n)},save:(t,n,o)=>{e("POST",t,n,o)}}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),n=e.querySelector("#housing-price"),o=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests"),a=e.querySelector(".map__features");window.filters={applyAll:e=>e.filter((e=>{return i=e,("any"===t.value||t.value===i.offer.type)&&(e=>"any"===n.value||"low"===n.value&&e.offer.price<window.constants.priceLimits.LOW||"middle"===n.value&&e.offer.price>=window.constants.priceLimits.LOW&&e.offer.price<=window.constants.priceLimits.HIGH||"high"===n.value&&e.offer.price>window.constants.priceLimits.HIGH)(e)&&(e=>"any"===o.value||+o.value===e.offer.rooms)(e)&&(e=>"any"===r.value||+r.value===e.offer.guests)(e)&&(e=>{const t=a.querySelectorAll(".map__checkbox:checked");if(0===t.length)return!0;let n=!0;return t.forEach((t=>{e.offer.features.includes(t.value)||(n=!1)})),n})(e);var i})).slice(0,window.constants.MAX_PIN_ON_MAP),onMapFilterChange:()=>{window.map.deletePins(),window.card.remove(),window.util.debounce(window.map.renderPins(window.filters.applyAll(window.constants.pinsData)))}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=[],n=(e,t)=>({x:e.x-Math.floor(t.width/2),y:e.y-t.height-window.constants.PIN_POINTER_HEIGHT});window.pin={pins:t,set:o=>{const r=e.cloneNode(!0),a={width:r.style.width,height:r.style.height},i=n(o.location,a);return r.style.left=i.x+"px",r.style.top=i.y+"px",r.querySelector("img").src=o.author.avatar,r.querySelector("img").alt=o.author.title,r.addEventListener("click",(()=>{window.map.renderCard(o)})),r.addEventListener("keydown",(e=>{e.code===window.constants.ENTER_KEY&&(e.preventDefault(),window.map.renderCard(o))})),t.push(r),r},getLocation:n}})(),(()=>{const e=document.querySelector(".map .map__pin--main");window.dragging={draggingMainPin:t=>{t.preventDefault();let n={x:t.clientX,y:t.clientY};const o=t=>{t.preventDefault();const o=n.x-t.clientX,r=n.y-t.clientY;n={x:t.clientX,y:t.clientY};const a=e.offsetLeft-o,i=e.offsetTop-r,s=window.constants.mapDragArea.Y.TOP-(e.offsetHeight+window.constants.PIN_POINTER_HEIGHT),d=window.constants.mapDragArea.Y.BOTTOM-(e.offsetHeight+window.constants.PIN_POINTER_HEIGHT),c=window.constants.mapDragArea.X.LEFT-Math.floor(e.offsetWidth/2),l=window.constants.mapDragArea.X.RIGHT-Math.floor(e.offsetWidth/2);i>=s&&i<=d&&(e.style.top=i+"px"),a>=c&&a<=l&&(e.style.left=a+"px"),window.form.setAddress(a+Math.floor(e.offsetWidth/2),i+(e.offsetHeight+window.constants.PIN_POINTER_HEIGHT))},r=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r)}}})(),(()=>{const e=document.querySelector(".map .map__pin--main"),t=e=>{e.key===window.constants.ENTER_KEY&&(e.preventDefault(),window.page.activated())},n=e=>{e.preventDefault(),window.constants.LEFT_MOUSE_BUTTON.includes(e.button)&&window.page.activated()};e.addEventListener("mousedown",n),e.addEventListener("mousedown",window.dragging.draggingMainPin),e.addEventListener("keydown",t),window.mainPin={onMouseDown:n,onEnterDown:t}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters-container");window.map={renderPins:t=>{const n=e.querySelector(".map__pins"),o=document.createDocumentFragment();window.util.getRandomFromArray(t).forEach((e=>{e.hasOwnProperty("offer")&&o.appendChild(window.pin.set(e))})),n.appendChild(o)},deletePins:()=>{window.pin.pins.length>0&&window.pin.pins.forEach((e=>{e.remove()})),window.card.remove()},renderCard:n=>{window.card.remove(),e.insertBefore(window.card.set(n),t)}}})(),(()=>{const e=document.querySelector(".map__filters"),t=document.querySelector("#success").content.querySelector(".success");window.success={dataHandler:t=>{window.constants.pinsData=t,window.constants.pinsData.length?window.map.renderPins(window.filters.applyAll(window.constants.pinsData)):window.page.setDisabled([e],!0)},formHandler:()=>{window.form.reset(),(()=>{const e=t.cloneNode(!0);document.body.appendChild(e);const n=e=>{e.code===window.constants.ESC_KEY&&document.contains(document.querySelector(".success"))&&(e.preventDefault(),document.querySelector(".success").remove(),document.removeEventListener("keydown",n))},o=e=>{document.contains(document.querySelector(".success"))&&(e.preventDefault(),document.querySelector(".success").remove(),document.removeEventListener("click",o))};document.addEventListener("keydown",n),document.addEventListener("click",o)})()}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector("#card").content.querySelector(".map__card"),n=document.createDocumentFragment(),o=()=>{const t=e.querySelector(".map__card");e.contains(t)&&t.remove()},r=()=>{o(),document.removeEventListener("keydown",a)},a=e=>{e.code===window.constants.ESC_KEY&&o()};window.card={set:e=>{const o=t.cloneNode(!0),{title:i,address:s,price:d,type:c,rooms:l,guests:u,checkin:m,checkout:w,description:p,features:y,photos:v}=e.offer,f=window.util.declension(["комната","комнаты","комнат"],l),h=window.util.declension(["гостя","гостей","гостей"],u);return o.querySelector(".popup__title").textContent=i,o.querySelector(".popup__text--address").textContent=s,o.querySelector(".popup__text--price").firstChild.textContent=d+"₽",o.querySelector(".popup__type").textContent=window.constants.typesOfAccommodation[c],o.querySelector(".popup__text--capacity").textContent=`${l} ${f} для ${u} ${h}`,o.querySelector(".popup__text--time").textContent=`Заезд после ${m} выезд до ${w}`,o.querySelector(".popup__description").textContent=p,((e,t)=>{t.innerHTML="",e.forEach((e=>{const n=document.createElement("li");n.classList.add("popup__feature",window.constants.featuresClasses[e]),t.appendChild(n)}))})(y,o.querySelector(".popup__features")),((e,t)=>{const o=t.querySelector(".popup__photo");let r;t.innerHTML="",e.forEach((e=>{r=o.cloneNode(!1),r.src=e,n.appendChild(r)})),t.appendChild(n)})(v,o.querySelector(".popup__photos")),o.querySelector(".popup__avatar").src=e.author.avatar,o.querySelector(".popup__close").addEventListener("click",r),document.addEventListener("keydown",a),o},remove:o}})(),(()=>{const e=document.querySelector(".ad-form__field input[type=file]"),t=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__upload input[type=file]"),o=document.querySelector(".ad-form__photo"),r=(e,t)=>{const n=e.files[0],o=n.name.toLowerCase();if(window.constants.FILE_TYPES.some((e=>o.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{t.src=e.result})),e.readAsDataURL(n)}};window.photo={onChangeAvatar:()=>{r(e,t)},onChangePhoto:()=>{if(!o.querySelector("img")){const e=document.createElement("IMG");e.width="70",e.height="70",e.alt="Фотография помещения",o.appendChild(e)}const e=document.querySelector(".ad-form__photo img");r(n,e)}}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector(".map__filters"),n=document.querySelector(".ad-form__photo"),o=()=>{100===parseInt(e.rooms.value,10)&&parseInt(e.capacity.value,10)>0?e.capacity.setCustomValidity("Не для гостей"):parseInt(e.rooms.value,10)<parseInt(e.capacity.value,10)?e.capacity.setCustomValidity("На всех гостей комнат не хватит"):100===parseInt(e.rooms.value,10)||parseInt(e.capacity.value,10)?e.capacity.setCustomValidity(""):e.capacity.setCustomValidity("Для гостей")},r=()=>{const t=parseInt(e.rooms.value,10);Array.from(e.capacity.options).forEach((e=>{const n=parseInt(e.value,10);e.disabled=100===t?!!n:t<n||!n}))},a=()=>{e.capacity.value=e.rooms.value<100?e.rooms.value:0},i=()=>{a(),r()},s=()=>{o()},d=()=>{e.timeout.value=e.timein.value},c=()=>{e.timein.value=e.timeout.value},l=()=>{e.price.min=window.constants.minPrice[e.type.value],e.price.placeholder=window.constants.minPrice[e.type.value]},u=()=>{l()},m=()=>{document.querySelector(".ad-form-header__preview img").src=window.constants.AVATAR_SRC,n.querySelector("img")&&n.querySelector("img").remove(),e.reset(),window.page.setState(!0),window.page.deactivated()};t.addEventListener("change",window.filters.onMapFilterChange),window.form={setCapacityValue:a,setCapacityDisabled:r,onResetClick:e=>{e.preventDefault(),m()},onResetKeydown:e=>{e.preventDefault(),e.code===window.constants.ENTER_KEY&&m()},reset:m,setPrice:l,setAddress:(t,n)=>{e.address.value=`${t}, ${n}`},onSubmit:t=>{t.preventDefault(),window.util.checkFormValidation(e),e.checkValidity()&&window.backend.save(window.success.formHandler,window.errors.formHandler,new FormData(e))},onSubmitClick:()=>{o(),window.util.checkFormValidation(e),e.checkValidity()&&window.backend.save(window.success.formHandler,window.errors.renderPostPopupMessage,new FormData(e))},addListenersToFields:()=>{e.capacity.addEventListener("change",s),e.rooms.addEventListener("change",i),e.type.addEventListener("change",u),e.timein.addEventListener("change",d),e.timeout.addEventListener("change",c),e.avatar.addEventListener("change",window.photo.onChangeAvatar),e.images.addEventListener("change",window.photo.onChangePhoto)},removeListenersFromFields:()=>{e.capacity.removeEventListener("change",s),e.rooms.removeEventListener("change",i),e.type.removeEventListener("change",u),e.timein.removeEventListener("change",d),e.timeout.removeEventListener("change",c),e.avatar.removeEventListener("change",window.photo.onChangeAvatar),e.images.removeEventListener("change",window.photo.onChangePhoto)}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),n=document.querySelector(".ad-form"),o=document.querySelector(".map__filters"),r=window.pin.getLocation(window.constants.mainPinLocation,window.constants.mainPinSize),a=(e,t=!0)=>{e.forEach((e=>{Array.from(e.children).forEach((e=>{e.disabled=t}))}))},i=(t=!0)=>{t?(n.classList.add("ad-form--disabled"),e.classList.add("map--faded"),n.querySelector(".ad-form__submit").removeEventListener("click",window.form.onSubmitClick),n.removeEventListener("submit",window.form.onSubmit),document.querySelector(".ad-form__reset").removeEventListener("click",window.form.onResetClick),document.querySelector(".ad-form__reset").removeEventListener("keydown",window.form.onResetKeydown)):(n.classList.remove("ad-form--disabled"),e.classList.remove("map--faded"),n.querySelector(".ad-form__submit").addEventListener("click",window.form.onSubmitClick),n.addEventListener("submit",window.form.onSubmit),document.querySelector(".ad-form__reset").addEventListener("click",window.form.onResetClick),document.querySelector(".ad-form__reset").addEventListener("keydown",window.form.onResetKeydown)),a([o,n],t)};window.page={activated:()=>{i(!1),window.util.setInputValue(n.querySelector("#address"),`${r.x}, ${r.y}`),window.form.setCapacityValue(),window.form.setCapacityDisabled(),window.form.setPrice(),window.backend.load(window.success.dataHandler,window.errors.renderErrorNode),n.title.focus(),n.capacity.style.outline="",window.form.addListenersToFields(),t.removeEventListener("mousedown",window.mainPin.onMouseDown),t.removeEventListener("keydown",window.mainPin.onEnterDown)},deactivated:()=>{i(!0),window.map.deletePins(),t.style.left=window.constants.initialMainPinLocation.X,t.style.top=window.constants.initialMainPinLocation.Y,window.util.setInputValue(n.querySelector("#address"),`${r.x}, ${r.y}`),window.form.removeListenersFromFields(),t.addEventListener("mousedown",window.mainPin.onMouseDown),t.addEventListener("keydown",window.mainPin.onEnterDown)},setState:i,setDisabled:a}})(),window.page.setState()})();